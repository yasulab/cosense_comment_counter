# 🔐 プライベートCosenseページアクセス設定ガイド

このガイドでは、プライベートCosenseページにアクセスするために必要なセットアップ手順を説明します。

## ⚠️ 重要な前提情報

**2025年8月時点の状況**:
- CosenseにはOAuthやPersonal Access Tokenがまだ実装されていません
- プライベートページへのアクセスには、ブラウザのセッションCookie（`connect.sid`）が必要です
- このCookieは約30日で期限切れになるため、定期的な更新が必要です

## 📋 必要な作業一覧

### A. Cookie から `connect.sid` を取得する
1. ブラウザで Private Cosense のトップページにアクセス
2. Opt + Cmd で開発者ツールを開く
3. 「Application」タブを選択
4. 「Cookies」→「https://scrapbox.io」を選択
5. `connect.sid`のCookieを探し、「Value」を選択
6. `Show URL-decoded` を選択し、値をコピー (例: `s%3A123...` -> `s:1234`)
7. `.env`ファイルにコピーした値を記載する

```env
# Cosense認証情報
COSENSE_SID=s:123...
```

### 3. 動作確認

以下のコマンドで設定が正しいか確認できます：

```bash
# 環境変数が設定されているか確認
echo $COSENSE_SID

# Rubyスクリプトの実行
ruby main.rb [ページ名]
```

## 🔄 Cookie更新手順（約30日ごと）

### Cookie期限切れの兆候
- APIが401 Unauthorizedエラーを返す
- ページデータが取得できなくなる

### 更新手順
1. 上記「1. connect.sid Cookieの取得」を再度実行
2. `.env`ファイルまたは環境変数を新しい値で更新
3. スクリプトを再実行して動作確認

## 🔒 セキュリティ上の注意事項

### ⚠️ 絶対にやってはいけないこと
- ❌ `connect.sid`をGitHubなどの公開リポジトリにコミットする
- ❌ Cookieをソースコードに直接記載する
- ❌ 他人とCookieを共有する（アカウント全体へのアクセス権限と同等）

### ✅ 推奨事項
- ✅ `.env`ファイルは必ず`.gitignore`に追加
- ✅ 環境変数または安全な設定管理システムを使用
- ✅ 定期的にCookieを更新（セキュリティ向上のため）
- ✅ 不要になったCookieはCosenseからログアウトして無効化

## 🆘 トラブルシューティング

### Q: Cookieが見つからない
**A**: 以下を確認してください：
- Cosenseに正しくログインしているか
- プライベートプロジェクトにアクセスできているか
- 開発者ツールで正しいドメイン（scrapbox.io）を選択しているか

### Q: 401 Unauthorizedエラーが出る
**A**: 以下の原因が考えられます：
- Cookieの有効期限切れ（新しいCookieを取得）
- Cookie値のコピーミス（特に先頭の`s:`部分）
- URLデコードの忘れ（`%3A`→`:`の変換）

### Q: Rate Limitエラー（429）が出る
**A**: APIアクセスが多すぎます：
- リクエスト間隔を1秒以上空ける
- 一度に取得するページ数を減らす

### Q: RubyスクリプトでCookieを自動取得できますか？
**A**: 技術的には**可能**ですが、**強く非推奨**です。

#### なぜ非推奨なのか

1. **🔓 深刻なセキュリティリスク**
   - `connect.sid`は完全なアカウント権限（漏洩＝全権限喪失）
   - ログやクラッシュダンプに残る危険性

2. **🔧 メンテナンス地獄**
   - Chrome: 4週間ごとのアップデートで頻繁に動作不良
   - Selenium: 2025年だけで6回のバージョン変更
   - 年間メンテナンス: 約34時間 vs 手動作業: 6分/年

3. **🚫 アカウントリスク**
   - 自動ログイン検出によるアカウントロックアウトの可能性

#### 📊 コスト比較

| 方法 | 初期実装 | 月間メンテナンス | セキュリティリスク | 推奨度 |
|------|----------|------------------|-------------------|--------|
| 手動取得 | 0分 | 0.5分 | 低 | ⭐⭐⭐⭐⭐ |
| 自動化 | 2-4時間 | 1-3時間 | 高 | ⭐ |

**結論**: 月1回30秒の手動作業は、自動化のリスクとコストに見合いません

## 📝 設定チェックリスト

プライベートページアクセスを開始する前に、以下を確認してください：

- [ ] Cosenseアカウントでログイン済み
- [ ] 対象のプライベートプロジェクトにアクセス権限がある
- [ ] `connect.sid` Cookieを取得した
- [ ] Cookie値を正しくURLデコードした（`%3A`→`:`）
- [ ] `.env`ファイルまたは環境変数に設定した
- [ ] `.gitignore`に`.env`を追加した
- [ ] テスト実行で正常にデータが取得できた

## 🔗 参考リンク

- [Cosense Help（日本語）](https://scrapbox.io/help-jp/)
- [Cosense公式サイト](https://cosen.se/)
- プロジェクトリポジトリ: このドキュメントが含まれるリポジトリ

---

**Note**: このガイドは2025年8月時点の情報に基づいています。CosenseのAPI仕様は変更される可能性があるため、最新情報を確認してください。
